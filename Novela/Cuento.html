<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>El Guardián del Tiempo | Edición Interactiva</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Dancing+Script:wght@700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&family=Special+Elite&display=swap" rel="stylesheet">

    <style>
        /* --- ESTILOS GENERALES Y ATMÓSFERA --- */
        :root {
            --paper-color: #fcfbf9;
            --ink-color: #1a1a1a;
            --leather-color: #3e2723;
            --gold-accent: #d4af37;
            --highlight-color: #8a4b38;
            --shadow-intensity: 0.5;
        }

        body {
            font-family: 'Crimson Text', serif;
            background-color: #0c0a09; 
            color: var(--ink-color);
            overflow: hidden;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 2s ease;
        }

        /* Modificadores de Finales (Atmósfera) */
        body.ending-warm { background-color: #2a1e0a; }
        body.ending-cold { background-color: #101518; }

        /* Textura de mesa */
        .wood-texture {
            position: absolute;
            inset: 0;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.6' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.05'/%3E%3C/svg%3E");
            background-color: #1c1917;
            opacity: 1;
            pointer-events: none;
            z-index: -1;
            transition: background-color 2s ease;
        }

        body.ending-warm .wood-texture { background-color: #422006; }
        body.ending-cold .wood-texture { background-color: #0f172a; }

        #book-wrapper {
            perspective: 2500px; 
            width: 95%;
            max-width: 1200px;
            height: 90vh;
            max-height: 800px;
            position: relative;
            transition: transform 0.5s ease;
        }

        .book-spread {
            width: 100%;
            height: 100%;
            background-color: var(--paper-color);
            box-shadow: 
                0 0 0 2px #44403c,
                inset 20px 0 50px rgba(0,0,0,0.2),
                0 30px 60px rgba(0,0,0,var(--shadow-intensity));
            border-radius: 4px;
            display: flex;
            position: relative;
            transform-style: preserve-3d;
            transition: box-shadow 2s ease;
        }

        /* --- PÁGINAS --- */
        .paper-texture {
            position: absolute;
            inset: 0;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
            opacity: 0.08;
            pointer-events: none;
            z-index: 10;
            mix-blend-mode: multiply;
        }

        .page-base {
            flex: 1;
            position: relative;
            height: 100%;
            overflow: hidden;
            z-index: 1;
        }

        .page-left-base {
            padding: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(to right, #e7e5e4, #f5f5f4 15%, #fcfbf9 100%);
            border-right: 1px solid rgba(0,0,0,0.08);
        }

        .page-right-base {
            padding: 3rem 4rem;
            overflow-y: auto;
            background: linear-gradient(to left, #e7e5e4, #f5f5f4 15%, #fcfbf9 100%);
            scroll-behavior: smooth;
        }

        /* --- FLIPPER (Animación de página) --- */
        #page-turner {
            position: absolute;
            top: 0;
            right: 0;
            width: 50%;
            height: 100%;
            transform-origin: left center;
            transform-style: preserve-3d;
            z-index: 50;
            pointer-events: none;
            transition: transform 1.2s cubic-bezier(0.645, 0.045, 0.355, 1);
        }

        #page-turner.flipped {
            transform: rotateY(-180deg);
        }

        .turner-face {
            position: absolute;
            inset: 0;
            backface-visibility: hidden;
            background-color: var(--paper-color);
            overflow: hidden;
        }

        .turner-front {
            background: linear-gradient(to left, #e7e5e4, #fcfbf9 20%);
            padding: 3rem 4rem;
            border-left: 1px solid rgba(0,0,0,0.05);
            z-index: 2;
        }

        .turner-back {
            transform: rotateY(180deg);
            background: linear-gradient(to right, #e7e5e4, #fcfbf9 20%);
            padding: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1;
        }

        /* --- PORTADA --- */
        #book-cover {
            position: absolute;
            inset: 0;
            background-color: var(--leather-color);
            background-image: radial-gradient(#4e342e 1px, transparent 1px);
            background-size: 10px 10px;
            border: 4px solid #271c19;
            border-radius: 4px 10px 10px 4px;
            box-shadow: inset 10px 0 20px rgba(0,0,0,0.5), 20px 20px 50px rgba(0,0,0,0.6);
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transform-origin: left;
            transition: transform 1.8s cubic-bezier(0.645, 0.045, 0.355, 1);
            cursor: pointer;
            backface-visibility: hidden;
        }

        #book-cover.open {
            transform: rotateY(-180deg);
            pointer-events: none;
        }

        /* Decoración Portada */
        .cover-border {
            border: 3px double var(--gold-accent);
            padding: 3rem;
            width: 80%;
            height: 90%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        /* --- NARRATIVA Y TEXTO --- */
        .act-label {
            font-family: 'Cinzel', serif;
            font-size: 0.75rem;
            letter-spacing: 0.2em;
            color: #a8a29e;
            text-transform: uppercase;
            margin-bottom: 0.5rem;
            display: block;
        }

        .chapter-title {
            font-family: 'Cinzel', serif;
            color: var(--highlight-color);
            border-bottom: 1px solid #d6d3d1;
            padding-bottom: 1rem;
            margin-bottom: 1.5rem;
            position: relative;
        }
        
        /* Efecto de "tinta fresca" para el texto */
        .fade-in-ink {
            animation: inkFlow 1s ease-out forwards;
            opacity: 0;
        }

        @keyframes inkFlow {
            0% { opacity: 0; transform: translateY(5px); filter: blur(2px); }
            100% { opacity: 1; transform: translateY(0); filter: blur(0); }
        }

        .narrative-text {
            font-size: 1.15rem;
            line-height: 1.8;
            color: #292524;
            text-align: justify;
        }

        /* Estilo para relecturas (New Game+) */
        .echo-text {
            font-family: 'Special Elite', cursive; /* Estilo máquina de escribir fantasmal */
            color: #78716c;
            font-size: 0.95rem;
            margin-top: 1rem;
            padding-left: 1rem;
            border-left: 2px solid #e7e5e4;
            display: block;
            opacity: 0.8;
        }

        /* --- VISUAL DE CÓMIC (MEJORADO) --- */
        .comic-layout {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            grid-template-rows: repeat(12, 1fr);
            gap: 8px;
            width: 100%;
            height: 100%;
            max-width: 550px; 
            max-height: 750px;
            padding: 12px;
            background-color: #fff;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 1px solid #d6d3d1;
            transition: all 0.5s ease;
        }

        /* Estados emocionales del layout */
        .layout-calm { transform: rotate(-1deg); }
        .layout-tense { transform: rotate(1deg) scale(0.98); border-color: #57534e; }
        .layout-broken { transform: rotate(2deg); gap: 12px; background-color: #fafafa; }

        .comic-panel {
            border: 2px solid #1c1917;
            background-color: #f5f5f4;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .comic-panel:hover { border-color: var(--highlight-color); }

        /* REDISEÑO DE LAYOUT: FOCO EN VERTICALIDAD (RETRATOS)
           Nuevo estándar: 1 Principal Vertical (Izq) + 2 Secundarias Apiladas (Der)
        */
        .panel-main { 
            grid-column: span 7; /* Antes 12 (Horizontal) -> Ahora 7 (Vertical) */
            grid-row: span 12;   /* Antes 8 -> Ahora 12 (Full Height) */
        }
        .panel-sub-1 { 
            grid-column: span 5; /* Columna derecha */
            grid-row: span 6;    /* Mitad superior */
        }
        .panel-sub-2 { 
            grid-column: span 5; /* Columna derecha */
            grid-row: span 6;    /* Mitad inferior */
        }

        /* Variación para escenas de tensión (Mantiene variedad pero ajustada) */
        .layout-tense .panel-main { grid-column: span 8; grid-row: span 12; order: 2; } /* Derecha grande */
        .layout-tense .panel-sub-1 { grid-column: span 4; grid-row: span 6; order: 1; } /* Izq arriba */
        .layout-tense .panel-sub-2 { grid-column: span 4; grid-row: span 6; order: 3; } /* Izq abajo */

        /* --- UI DE DECISIÓN Y MEMORIA --- */
        .choice-btn {
            text-align: left;
            width: 100%;
            padding: 1rem 1.2rem;
            margin-bottom: 0.8rem;
            border-left: 3px solid var(--highlight-color);
            background: rgba(138, 75, 56, 0.03);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            font-family: 'Crimson Text', serif;
            font-size: 1.05rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            overflow: hidden;
        }
        
        .choice-btn:hover { 
            background: rgba(138, 75, 56, 0.1); 
            padding-left: 1.8rem;
            border-left-width: 6px;
        }

        /* Indicador de memoria (REUBICADO Y MEJORADO) */
        .memory-hud-top {
            width: 100%;
            margin-bottom: 1rem;
            display: flex;
            gap: 1.5rem;
            font-family: 'Cinzel', serif;
            font-size: 0.8rem;
            color: #78716c;
            justify-content: flex-start;
            padding-left: 0.5rem;
        }

        .memory-icon { 
            display: flex; 
            align-items: center; 
            gap: 0.4rem; 
            opacity: 0.5; 
            transition: all 0.5s ease;
        }

        .memory-icon.active { 
            opacity: 1; 
            color: var(--highlight-color); 
            font-weight: bold; 
        }

        /* Animación de "Deslumbramiento" (Flash) */
        @keyframes flash-gold {
            0% { 
                color: #d4af37; 
                text-shadow: 0 0 10px #d4af37, 0 0 20px #d4af37; 
                transform: scale(1.3); 
                opacity: 1; 
            }
            100% { 
                color: var(--highlight-color); 
                text-shadow: none; 
                transform: scale(1); 
                opacity: 1; 
            }
        }

        .memory-flash {
            animation: flash-gold 2s ease-out forwards;
            font-weight: bold;
            opacity: 1 !important;
            color: #d4af37 !important;
        }

        /* --- RESPONSIVE MEJORADO Y CORREGIDO --- */
        @media (max-width: 768px) {
            /* 1. Ajuste del contenedor general para ocupar toda la pantalla */
            .book-spread { 
                flex-direction: column; 
                height: 100vh;
                overflow: hidden;
            }
            
            #book-wrapper {
                height: 100vh;
                max-height: none;
                width: 100%;
            }

            #page-turner { display: none; } 
            
            /* 2. Área Visual: Ocupa la mitad superior (50%) */
            .page-base { flex: none; height: auto; }
            .page-left-base { 
                height: 50vh; 
                min-height: 280px; /* Asegura espacio mínimo para imágenes */
                padding: 0.5rem; 
                border-right: none; 
                border-bottom: 1px solid #d6d3d1; 
                overflow: hidden;
            }
            
            /* 3. Área de Texto: Ocupa la mitad inferior */
            .page-right-base { 
                flex: 1; 
                padding: 1.5rem; 
                overflow-y: auto;
            }
            
            #book-cover { width: 100%; }
            
            /* 4. LAYOUT CÓMIC MÓVIL: GRID SIMPLIFICADO */
            .comic-layout { 
                max-width: 100%; 
                height: 100%; 
                max-height: none;
                display: grid;
                grid-template-columns: 1fr 1fr; 
                grid-template-rows: 2fr 1fr; /* Principal grande arriba, Secundarias abajo */
                gap: 4px;
                padding: 4px;
            }
            
            /* Panel Principal: Ocupa todo el ancho superior */
            .panel-main { 
                grid-column: 1 / -1 !important; 
                grid-row: 1 !important;
                order: 1;
            }
            
            /* Paneles Secundarios: Comparten la fila inferior */
            .panel-sub-1 { 
                grid-column: 1 / 2 !important; 
                grid-row: 2 !important;
                order: 2;
            }
            
            .panel-sub-2 { 
                grid-column: 2 / 3 !important; 
                grid-row: 2 !important;
                order: 3;
            }

            /* Aseguramos que las viñetas no colapsen */
            .comic-panel {
                min-height: 0; 
            }
        }

        /* ============================================================
           AJUSTES DE NARRATIVA VISUAL (FINAL)
           Objetivo: Llenado perfecto + Visibilidad de Caras
           ============================================================ */

        .comic-panel {
            overflow: hidden !important;
            padding: 0 !important;
            background-color: #1c1917; 
            position: relative;
        }

        .comic-panel img,
        .comic-panel svg {
            width: 100% !important;
            height: 100% !important;
            
            /* 1. Llenar viñeta por completo */
            object-fit: cover !important;
            
            /* 2. ALINEACIÓN CLAVE: TOP CENTER
               Esto prioriza las cabezas y caras en retratos verticales,
               evitando que se corten al ajustar la imagen. */
            object-position: top center !important;
            
            display: block !important;
            margin: 0 !important;
            border: none !important;
            opacity: 1 !important; 
        }

        .comic-panel svg[class*="p-4"] {
            padding: 0 !important;
        }

    </style>
</head>
<body>

    <div class="wood-texture"></div>

    <div id="book-wrapper">
        <!-- PORTADA -->
        <div id="book-cover" onclick="openBook()">
            <div class="cover-border">
                <div class="absolute top-2 left-2 w-4 h-4 border-t-2 border-l-2 border-[#d4af37]"></div>
                <div class="absolute top-2 right-2 w-4 h-4 border-t-2 border-r-2 border-[#d4af37]"></div>
                <div class="absolute bottom-2 left-2 w-4 h-4 border-b-2 border-l-2 border-[#d4af37]"></div>
                <div class="absolute bottom-2 right-2 w-4 h-4 border-b-2 border-r-2 border-[#d4af37]"></div>
                
                <h1 class="text-5xl md:text-7xl font-bold text-[#d4af37] mb-2 text-center drop-shadow-lg" style="font-family: 'Cinzel', serif;">El Guardián<br><span class="text-3xl md:text-5xl">del Tiempo</span></h1>
                <div class="w-16 h-1 bg-[#d4af37] my-6"></div>
                <p class="text-[#e6cfa3] text-xl font-serif italic text-center">Un estudio sobre la memoria y el olvido</p>
                
                <div id="read-count-badge" class="mt-8 text-xs text-[#a1887f] font-mono hidden opacity-70">
                    Ciclo de lectura: <span id="cycle-num">1</span>
                </div>

                <div class="mt-12 text-[#d4af37] text-sm tracking-widest uppercase animate-pulse border px-4 py-1 border-[#d4af37] rounded-sm">Abrir Libro</div>

                <!-- OPCIÓN DE REINICIO AÑADIDA -->
                <button onclick="resetReadingCycles(event)" class="mt-4 text-[10px] text-[#a1887f] hover:text-[#d4af37] underline decoration-dotted opacity-50 hover:opacity-100 transition-opacity font-serif z-50 tracking-wide uppercase">
                    Reiniciar memoria (Borrar progreso)
                </button>

            </div>
        </div>

        <!-- SPREAD -->
        <div class="book-spread">
            <div class="paper-texture"></div>

            <!-- FLIPPER -->
            <div id="page-turner" class="hidden">
                <div class="turner-face turner-front" id="turner-content-front"></div>
                <div class="turner-face turner-back" id="turner-content-back"></div>
            </div>

            <!-- IZQUIERDA: CÓMIC -->
            <div class="page-base page-left-base" id="visual-page"></div>

            <!-- DERECHA: TEXTO -->
            <div class="page-base page-right-base" id="text-page"></div>
        </div>
    </div>

    <script>
        // --- 1. GESTIÓN DE ESTADO Y MEMORIA (NUEVO) ---
        const GameState = {
            memories: {
                nostalgia: 0,
                pragmatism: 0,
                empathy: 0,
                fear: 0
            },
            playCount: 0,
            lastEarned: null, // Para saber qué brillar
            
            init() {
                const savedCount = localStorage.getItem('guardian_play_count');
                this.playCount = savedCount ? parseInt(savedCount) : 0;
                this.updateUI();
                this.lastEarned = null;
            },
            
            recordChoice(type) {
                if(type && this.memories[type] !== undefined) {
                    this.memories[type]++;
                    this.lastEarned = type; // Guardar el último ganado
                } else {
                    this.lastEarned = null;
                }
            },

            completeGame() {
                this.playCount++;
                localStorage.setItem('guardian_play_count', this.playCount);
            },

            resetMemories() {
                this.memories = { nostalgia: 0, pragmatism: 0, empathy: 0, fear: 0 };
                this.lastEarned = null;
            },

            updateUI() {
                const cycleEl = document.getElementById('cycle-num');
                const badgeEl = document.getElementById('read-count-badge');
                if (this.playCount > 0 && cycleEl) {
                    badgeEl.classList.remove('hidden');
                    cycleEl.textContent = this.playCount + 1;
                } else {
                    // Asegurar que se oculta si es 0
                    if (badgeEl) badgeEl.classList.add('hidden');
                }
            }
        };

        // --- 2. DATOS DE LA HISTORIA (ENRIQUECIDOS) ---
        const STORY_DATA = {
            start: {
                id: 'start',
                act: 'Acto I: El Retorno',
                title: 'La Casa del Abuelo',
                text: 'El olor a té de canela y polvo antiguo lo inunda todo. Has vuelto a la casa después de años. En el centro de la habitación, el viejo sillón del abuelo parece esperarlo todavía, una isla de terciopelo en un mar de silencio.',
                text2: 'El abuelo siempre contaba historias sobre una criatura llamada "El Guardián", capaz de reparar lo que el tiempo rompía. Tú, de niño, le creías ciegamente. Ahora, solo ves muebles viejos.',
                echoText: 'La casa parece recordar tus pasos. Sientes que ya has estado aquí, en este mismo instante, tomando esta misma decisión.', // Solo en relectura
                layout: 'layout-calm',
                visualType: 'house_interior',
                secondaryVisuals: ['dust_motes', 'armchair'],
                choices: [
                    { text: 'Aferrarse al recuerdo infantil', next: 'flashback_reveal', memory: 'nostalgia' },
                    { text: 'Analizar la habitación racionalmente', next: 'explore_room', memory: 'pragmatism' }
                ]
            },
            explore_room: {
                id: 'explore_room',
                act: 'Acto I: El Retorno',
                title: 'Ecos Racionales',
                text: 'Tus dedos recorren las estanterías vacías. Encuentras un juguete de madera roto que escondiste hace años. La madera está astillada, la pintura desvanecida. Un objeto inerte.',
                text2: 'De repente, un ruido en el desván te hace mirar hacia arriba. Las vigas crujen. La lógica dicta que son ratones o el viento. Pero tu corazón late con un ritmo antiguo.',
                layout: 'layout-tense',
                visualType: 'broken_toy',
                secondaryVisuals: ['eye_watching', 'cobweb'],
                choices: [
                    { text: 'Investigar el ruido (Valentía)', next: 'reunion_attic', memory: 'fear' },
                    { text: 'Recordar qué pasó con el reloj', next: 'flashback_reveal', memory: 'nostalgia' }
                ]
            },
            flashback_reveal: {
                id: 'flashback_reveal',
                act: 'Acto I: El Retorno',
                title: 'La Anatomía del Tiempo',
                text: 'Tenías siete años. El abuelo puso sobre la mesa el reloj de la abuela, destrozado por una caída. "Observa", susurró, como quien comparte un secreto de estado.',
                text2: 'De las sombras emergió Él. No era un monstruo. Era una criatura hecha de retales, botones y olvidos. Sus manos cosieron el metal como si fuera tela. El Guardián era real, y tú fuiste testigo.',
                layout: 'layout-calm',
                visualType: 'guardian_repairing',
                secondaryVisuals: ['clock_face', 'needle_thread'],
                choices: [
                    { text: 'Volver al presente y subir al desván', next: 'reunion_attic', memory: 'empathy' }
                ]
            },
            reunion_attic: {
                id: 'reunion_attic',
                act: 'Acto II: La Costura',
                title: 'El Reencuentro',
                text: 'El desván está en penumbra. Allí, sentado sobre un baúl viejo, está Él. Pero ha cambiado. Está deshilachado, le falta un ojo de botón, y se cose a sí mismo con movimientos lentos y dolorosos.',
                text2: '"Me olvidaste", dice con voz de papel arrugado. "Cuando nos olvidan, nos rompemos". Su acusación no tiene ira, solo una tristeza infinita.',
                layout: 'layout-broken',
                visualType: 'guardian_broken',
                secondaryVisuals: ['broken_button', 'tear_drop'],
                choices: [
                    { text: 'Mostrarle el reloj inmediatamente', next: 'show_clock', memory: 'pragmatism' },
                    { text: 'Pedirle perdón por el olvido', next: 'apology', memory: 'empathy' }
                ]
            },
            apology: {
                id: 'apology',
                act: 'Acto II: La Costura',
                title: 'Palabras Tardías',
                text: '"Lo siento", susurras. "Crecí. La vida adulta me alejó". El Guardián asiente lentamente, sin detener su aguja. Parece reconfortado por tu voz.',
                text2: '"El tiempo adulto es cruel con la magia", responde. Sacas el reloj del bolsillo. Se detuvo el día que murió el abuelo. Un objeto muerto esperando resurrección.',
                layout: 'layout-calm',
                visualType: 'guardian_sad',
                secondaryVisuals: ['hand_offer', 'heart_stitch'],
                choices: [
                    { text: 'Pedir que repare el reloj', next: 'the_condition', memory: 'empathy' }
                ]
            },
            show_clock: {
                id: 'show_clock',
                act: 'Acto II: La Costura',
                title: 'El Objeto Sagrado',
                text: 'Sacas el reloj sin preámbulos. Brilla débilmente en la oscuridad. El único ojo del Guardián se fija en él con avidez y hambre.',
                text2: '"Aún lo conservas", murmura. "Puedo arreglarlo. Pero estoy débil. Mi magia se alimenta de la memoria viva, y tú llevas años vacío".',
                layout: 'layout-tense',
                visualType: 'clock_closeup',
                secondaryVisuals: ['gear', 'eye_watching'],
                choices: [
                    { text: 'Preguntar qué necesita', next: 'the_condition', memory: 'pragmatism' }
                ]
            },
            the_condition: {
                id: 'the_condition',
                act: 'Acto III: El Juicio',
                title: 'La Balanza',
                text: 'El Guardián se acerca. "Si reparo este reloj, gastaré mi última energía. Solo sobreviviré si te quedas a vivir aquí, alimentando la casa con tus recuerdos diarios."',
                text2: '"Si te vas con el reloj arreglado, yo desapareceré para siempre en el polvo". La elección es una guillotina: el objeto perfecto o la criatura viva.',
                echoText: 'La última vez dudaste. Esta vez sabes el peso de la soledad.',
                layout: 'layout-tense',
                visualType: 'scales_decision',
                secondaryVisuals: ['door_open', 'door_closed'],
                choices: [
                    { text: 'Quedarte: Salvar al Guardián, sacrificar tu vida fuera', next: 'ending_stay', memory: 'empathy' },
                    { text: 'Irte: Conservar el reloj, sacrificar al Guardián', next: 'ending_leave', memory: 'pragmatism' }
                ]
            },
            ending_stay: {
                id: 'ending_stay',
                act: 'Epílogo',
                isEnding: true,
                title: 'El Nuevo Guardián',
                text: 'Decides quedarte. Al pronunciar las palabras, el Guardián brilla. Su botón perdido reaparece cosido con hilo de oro. El reloj comienza a hacer tic-tac, un latido compartido.',
                text2: 'No sabes qué pasará mañana con tu trabajo o tu vida en la ciudad, pero mientras tomas té con una criatura de tela, sabes que has reparado algo más importante que un mecanismo.',
                layout: 'layout-calm',
                visualType: 'ending_happy',
                secondaryVisuals: ['sun_icon', 'tea_cup'],
                theme: 'ending-warm'
            },
            ending_leave: {
                id: 'ending_leave',
                act: 'Epílogo',
                isEnding: true,
                title: 'El Mecanismo Perfecto',
                text: 'Tomas el reloj reparado y bajas la cabeza. "Lo siento", dices. "Tengo una vida real fuera". El Guardián asiente y se deshace en un montón de trapos viejos y polvo.',
                text2: 'Sales de la casa. El reloj funciona perfecto, frío y exacto en tu muñeca. Pero mientras te alejas, sientes un hueco en el pecho, una puntada que se ha soltado y que nadie, nunca más, podrá coser.',
                layout: 'layout-broken',
                visualType: 'ending_sad',
                secondaryVisuals: ['cloud_rain', 'clock_broken'],
                theme: 'ending-cold'
            }
        };

        // --- 3. GENERADOR DE VISUALES (SIMBOLISMO DE CÓMIC) ---
        function getSvgIcon(type) {
            const icons = {
                // Viñetas Secundarias Simbólicas
                dust_motes: `<img src="images/casa_dentro.webp" alt="La casa como era antes por dentro" class="w-full h-full object-cover"/>`,
                armchair: `<img src="images/abuelo_cuento.webp" alt="El abuelo le cuenta un cuento al niño" class="w-full h-full object-cover"/>`,
                eye_watching: `<img src="images/juguete_roto.webp" alt="Juguete roto" class="w-full h-full object-cover"/>`,
                cobweb: `<img src="images/mirando_arriba.webp" alt="El chico mira hacia arriba sorprendido" class="w-full h-full object-cover"/>`,
                clock_face: `<img src="images/reloj_roto.webp" alt="Reloj roto" class="w-full h-full object-cover"/>`,
                needle_thread: `<img src="images/guardian_baul.webp" alt="Reloj roto" class="w-full h-full object-cover"/>`,
                broken_button: `<img src="images/guardian_reparado.webp" alt="Guardián reparándose" class="w-full h-full object-cover"/>`,
                tear_drop: `<img src="images/hilo_dorado.webp" alt="Hilo dorado" class="w-full h-full object-cover"/>`,
                hand_offer: `<img src="images/reloj_roto.webp" alt="El reloj roto" class="w-full h-full object-cover"/>`,
                heart_stitch: `<img src="images/guardian_reparing.webp" alt="Guardián reparando el reloj que le da el chico" class="w-full h-full object-cover"/>`,
                gear: `<img src="images/icono_ojo.webp" alt="El Guardián inspecciona el reloj roto" class="w-full h-full object-cover"/>`,
                door_open: `<img src="images/adulto_abrazando.webp" alt="El chico se imagina final feliz" class="w-full h-full object-cover"/>`,
                door_closed: `<img src="images/guardian_suplicando.webp" alt="El Guardián llora desesperadamente" class="w-full h-full object-cover"/>`,
                sun_icon: `<img src="images/adulto_escribiendo.webp" alt="El chico se dispone a escribir su historia con la criatura" class="w-full h-full object-cover"/>`,
                tea_cup: `<img src="images/cuento_guardian.webp" alt="El cuento que escribió el chico" class="w-full h-full object-cover"/>`,
                cloud_rain: `<img src="images/guardian_muriendo.webp" alt="El Guardián se va muriendo" class="w-full h-full object-cover"/>`,
                clock_broken: `<img src="images/final_triste.webp" alt="Final triste" class="w-full h-full object-cover"/>`,
                
                // Imágenes Principales (Placeholders artísticos)
                house_interior: `<img src="images/adulto.webp" alt="El niño ya adulto va a la casa" class="w-full h-full object-cover"/>`,
                broken_toy: `<img src="images/estanteria_polvorienta.webp" alt="El chico recorre la estanteria" class="w-full h-full object-cover"/>`,
                guardian_repairing: `<img src="images/abuelo_cuento.webp" alt="El abuelo contandole una historia al niño" class="w-full h-full object-cover"/>`,
                guardian_broken: `<img src="images/guardian_roto.webp" alt="Guardián roto" class="w-full h-full object-cover"/>`,
                guardian_sad: `<img src="images/guardian_baul.webp" alt="El Guardián en el baul" class="w-full h-full object-cover"/>`,
                clock_closeup: `<img src="images/reloj_roto.webp" alt="Reloj roto" class="w-full h-full object-cover"/>`,
                scales_decision: `<img src="images/adulto_dudando.webp" alt="El adulto no sabe qué hacer" class="w-full h-full object-cover"/>`,
                ending_happy: `<img src="images/final_feliz.webp" alt="Final feliz" class="w-full h-full object-cover"/>`,
                ending_sad: `<img src="images/adulto_irse.webp" alt="Final triste" class="w-full h-full object-cover"/>`
            };
            
            // CAMBIO: Devolvemos directamente la imagen para que el CSS funcione
            return icons[type] || '';
        }

        function generateVisualHTML(sceneId) {
            const scene = STORY_DATA[sceneId];
            if (!scene) return "";

            const mainVisual = getSvgIcon(scene.visualType);
            const subVisual1 = scene.secondaryVisuals ? getSvgIcon(scene.secondaryVisuals[0]) : '';
            const subVisual2 = scene.secondaryVisuals ? getSvgIcon(scene.secondaryVisuals[1]) : '';
            const layoutClass = scene.layout || 'layout-calm';

            // Detectar si debemos brillar algún icono
            const flashNostalgia = GameState.lastEarned === 'nostalgia' ? 'memory-flash' : '';
            const flashPragmatism = GameState.lastEarned === 'pragmatism' ? 'memory-flash' : '';
            const flashEmpathy = GameState.lastEarned === 'empathy' ? 'memory-flash' : '';

            return `
                <div class="w-full h-full flex flex-col items-center justify-center p-2 md:p-6">
                    
                    <!-- HUD DE MEMORIA REUBICADO -->
                    <div class="memory-hud-top">
                        <div class="memory-icon ${GameState.memories.nostalgia > 0 ? 'active' : ''} ${flashNostalgia}" title="Nostalgia">
                            <i data-lucide="hourglass" size="14"></i> <span>Pasado</span>
                        </div>
                        <div class="memory-icon ${GameState.memories.pragmatism > 0 ? 'active' : ''} ${flashPragmatism}" title="Pragmatismo">
                            <i data-lucide="brain-circuit" size="14"></i> <span>Lógica</span>
                        </div>
                        <div class="memory-icon ${GameState.memories.empathy > 0 ? 'active' : ''} ${flashEmpathy}" title="Empatía">
                            <i data-lucide="heart-handshake" size="14"></i> <span>Vínculo</span>
                        </div>
                    </div>

                    <div class="comic-layout ${layoutClass} flex-grow">
                        
                        <!-- VIÑETA PRINCIPAL -->
                        <div class="comic-panel panel-main">
                            ${mainVisual}
                            <div class="absolute bottom-2 right-2 bg-white px-2 py-1 text-xs font-serif border border-gray-300 opacity-80">Fig. 1</div>
                        </div>

                        <!-- VIÑETA SECUNDARIA 1 (Simbólica) -->
                        <div class="comic-panel panel-sub-1 bg-white">
                            ${subVisual1}
                        </div>

                        <!-- VIÑETA SECUNDARIA 2 (Simbólica) -->
                        <div class="comic-panel panel-sub-2 bg-white">
                            ${subVisual2}
                        </div>

                    </div>
                </div>
            `;
        }

        function generateTextHTML(sceneId) {
            const scene = STORY_DATA[sceneId];
            if (!scene) return "<p>Error de trama.</p>";

            // Detectar relectura para mostrar texto fantasma
            const showEcho = GameState.playCount > 0 && scene.echoText;

            // Variaciones sutiles según memoria (ejemplo en El Juicio)
            let dynamicText = scene.text2;
            if (sceneId === 'the_condition' && GameState.memories.empathy > GameState.memories.pragmatism) {
                dynamicText += " (El Guardián te mira con esperanza, ha sentido tu calidez previa).";
            }

            let html = `
                <div class="h-full flex flex-col fade-in-ink">
                    <div class="flex-grow">
                        <span class="act-label">${scene.act || ''}</span>
                        <h2 class="text-3xl md:text-4xl chapter-title">${scene.title}</h2>
                        
                        <div class="narrative-text mb-6">
                            <p class="mb-4 first-letter:text-5xl first-letter:float-left first-letter:mr-2 first-letter:font-bold first-letter:text-[#8a4b38]">
                                ${scene.text}
                            </p>
                            <p>${dynamicText}</p>
                            
                            ${showEcho ? `<p class="echo-text">${scene.echoText}</p>` : ''}
                        </div>
                    </div>
                    
                    <div class="mt-4">
            `;
            
            if (scene.choices) {
                scene.choices.forEach(choice => {
                    html += `
                        <button onclick="handleChoice('${choice.next}', '${choice.memory}')" class="choice-btn group">
                            <div class="z-10 relative">
                                <span class="block text-xs uppercase tracking-widest text-[#8a4b38] mb-1 font-bold opacity-70">Decisión</span>
                                <span class="font-semibold text-stone-800">${choice.text}</span>
                            </div>
                            <i data-lucide="chevron-right" class="text-[#8a4b38] opacity-50 group-hover:opacity-100 transition-opacity"></i>
                        </button>
                    `;
                });
                
                // HUD eliminado de aquí (movido a visual)

            } else if (scene.isEnding) {
                html += `
                    <div class="text-center mt-12 border-t border-[#d4af37] pt-8">
                        <p class="text-lg italic text-stone-500 mb-6 font-serif">Fin del Acto</p>
                        <button onclick="restartBook()" class="px-8 py-3 bg-[#3e2723] text-[#d4af37] font-serif rounded shadow-lg hover:bg-[#271c19] transition-colors border border-[#d4af37] tracking-widest uppercase text-sm">
                            Cerrar el libro
                        </button>
                    </div>
                `;
            }
            
            html += `</div></div>`;
            return html;
        }

        // --- 4. MOTOR (CORE) ---
        const visualPage = document.getElementById('visual-page');
        const textPage = document.getElementById('text-page');
        const bookCover = document.getElementById('book-cover');
        const pageTurner = document.getElementById('page-turner');
        const turnerFront = document.getElementById('turner-content-front');
        const turnerBack = document.getElementById('turner-content-back');
        const bodyEl = document.body;
        
        let currentSceneId = 'start';
        let isBookOpen = false;
        let isAnimating = false;

        function openBook() {
            if (!isBookOpen) {
                GameState.init(); // Inicializar estado
                visualPage.innerHTML = generateVisualHTML('start');
                textPage.innerHTML = generateTextHTML('start');
                bookCover.classList.add('open');
                isBookOpen = true;
                if (window.lucide) window.lucide.createIcons();
            }
        }

        function handleChoice(nextId, memoryType) {
            if (isAnimating) return;
            
            // Registrar memoria
            GameState.recordChoice(memoryType);
            
            turnPage(nextId);
        }

        function turnPage(nextId) {
            const isMobile = window.innerWidth <= 768;
            const nextScene = STORY_DATA[nextId];

            // Aplicar tema si es final
            if (nextScene.theme) {
                bodyEl.classList.add(nextScene.theme);
            }

            if (isMobile) {
                currentSceneId = nextId;
                visualPage.innerHTML = generateVisualHTML(nextId);
                textPage.innerHTML = generateTextHTML(nextId);
                if (textPage) textPage.scrollTop = 0;
                if (window.lucide) window.lucide.createIcons();
                return;
            }

            isAnimating = true;

            // Flipper setup (Pre-render)
            turnerFront.innerHTML = textPage.innerHTML;
            turnerBack.innerHTML = generateVisualHTML(nextId);
            
            // Preparar páginas base
            visualPage.innerHTML = generateVisualHTML(currentSceneId); // Mantener actual
            textPage.innerHTML = generateTextHTML(nextId); // Preparar siguiente texto (oculto por flipper)

            // Ejecutar animación
            pageTurner.classList.remove('hidden');
            pageTurner.classList.remove('flipped');
            void pageTurner.offsetWidth; // Force Reflow
            pageTurner.classList.add('flipped');

            setTimeout(() => {
                visualPage.innerHTML = generateVisualHTML(nextId); // Actualizar visual base
                pageTurner.classList.add('hidden');
                pageTurner.classList.remove('flipped'); 
                if (textPage) textPage.scrollTop = 0;
                currentSceneId = nextId;
                isAnimating = false;
                if (window.lucide) window.lucide.createIcons();
            }, 1200); 
        }

        function restartBook() {
            GameState.completeGame();
            bookCover.classList.remove('open');
            bodyEl.classList.remove('ending-warm', 'ending-cold'); // Limpiar temas
            isBookOpen = false;
            
            setTimeout(() => {
                GameState.resetMemories();
                currentSceneId = 'start';
                visualPage.innerHTML = '';
                textPage.innerHTML = '';
                GameState.updateUI(); // Actualizar badge de portada
            }, 1000);
        }

        // --- 5. FUNCIÓN NUEVA: REINICIO DE CICLOS ---
        function resetReadingCycles(e) {
            // Detener propagación para no activar openBook() al hacer clic en el botón
            if(e) e.stopPropagation();

            // 1. Limpiar persistencia
            localStorage.removeItem('guardian_play_count');
            
            // 2. Reiniciar estado interno
            GameState.playCount = 0;
            GameState.resetMemories();
            
            // 3. Actualizar UI inmediatamente
            GameState.updateUI();
            
            // Feedback visual (opcional)
            const btn = e.target;
            const originalText = btn.textContent;
            btn.textContent = "¡Memoria borrada!";
            setTimeout(() => btn.textContent = originalText, 2000);
        }
        
        // Inicialización
        window.onload = function() {
            GameState.init();
            if (window.lucide) lucide.createIcons();
        }
    </script>
</body>
</html>
